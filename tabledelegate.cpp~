#include "tabledelegate.h"

LeftDelegate::LeftDelegate(QWidget* parent)
  :QItemDelegate(parent)
{}

QWidget* LeftDelegate::createEditor(QWidget *parent, const QStyleOptionViewItem &option, const QModelIndex &index)
{
  if(index.column() == 4)
    {
      QWidget* pTmp = new QWidget(parent);
      QLineEdit* edit = new QLineEdit();
      edit->setObjectName("lineeditor");
      QPushButton* browse = new QPushButton(tr("..."));
      browse->setFixedWidth(30);
      QHBoxLayout *layout = new QHBoxLayout(pTmp);
      layout->setContentsMargins(0, 0, 0, 0);
      layout->setSpacing(0);
      layout->addWidget(edit);
      layout->addWidget(browse);
      m_sFilePath = "";
      connect(browse, &QPushButton::clicked, [&](){
	  QString sFilePath;
	  sFilePath=QFileDialog::getOpenFileName(Q_NULLPTR,tr("打开"),QString(),
						 tr("输入文件(*.*)"));
	  if(!sFilePath.isEmpty())
	    {
	      m_sFilePath = sFilePath;
	    }
	});

      return pTmp;
    }
  return QItemDelegate::createEditor(parent, option, index);
}


void LeftDelegate::setEditorData(QWidget *editor, const QModelIndex &index) const
{
  if(index.column() == 4)
    {
      if(m_sFilePath != "")
	{
	  editor->findChild<QLineEdit*>("lineeditor")->setText(m_sFilePath);
	}
    }
  else
    {
      QItemDelegate::setEditorData(editor, index);
    }
}

void LeftDelegate::setModelData(QWidget *editor, QAbstractItemModel *model, const QModelIndex &index) const
{
  if(index.column() ==4)
    {
      QString value = editor->findChild<QLineEdit*>("lineeditor")->text();
      model->setData(index, value);
    }
  else
    {
      QItemDelegate::setModelData(editor, model, index);
    }
}

void LeftDelegate::updateEditorGeometry(QWidget *editor, const QStyleOptionViewItem &option, const  QModelIndex &index) const
{
  editor->setGeometry(option.rect);
}
